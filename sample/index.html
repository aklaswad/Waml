<!DOCTYPE html>
  <head>
    <meta charset="UTF-8">
    <script src="Waml.js"></script>
    <script src="TriOscillator.js"></script>
    <script src="SimpleTremolo.js"></script>
  </head>
  <body>
    <h1>Waml demo</h1>
    <div>
      <canvas id="waveform" width="512", height="200" style="border: 1px solid #888;"></canvas>
    <div>max: <span id="max"></span></div>
    </div>
  <script>

function WaveFormRenderer (ctx,wave) {
  var proc = ctx.createScriptProcessor(2048,1,1);
  var canvas = document.getElementById('waveform');
  var cctx = canvas.getContext('2d');
  var maxElem = document.getElementById('max');
  cctx.strokeStyle = '#000';
  var frames = 0;
  var last = {max: 0, maxframe: 0 };
  proc.onaudioprocess = function(evt) {
    var i,channel = evt.inputBuffer.getChannelData(0);
    cctx.clearRect(0,0,canvas.width,canvas.height);
    cctx.moveTo(0,100);
    cctx.beginPath();
    var max = 0;
    for(i=0;i<512;i++){
      var vv = [];
      var idx = i * 4;
      vv[0] = channel[idx];
      vv[1] = channel[idx+1];
      vv[2] = channel[idx+2];
      vv[3] = channel[idx+3];
      var j,v = 0;
      var minv=1,maxv=-1,maxabsv = 0;
      for(j=0;j<4;j++) {
        if ( maxv < vv[j] ) {
          maxv=vv[j];
        }
        if ( vv[j] < minv ) {
          minv=vv[j];
        }
        if ( maxabsv < Math.abs(vv[j]) ) {
          maxabsv=Math.abs(vv[j]);
        }
      }
      cctx.lineTo(i,100 + -100 * minv);
      cctx.lineTo(i,100 + -100 * maxv);
      max = maxabsv;
    }
    if ( last.max < max || last.maxframe < frames - 8 ) {
      last.max = max;
      last.maxframe = frames;
      maxElem.innerHTML = max;
    }
    cctx.stroke();
    frames++;
  };
  wave.connect(proc);
  var mute = ctx.createGain();
  mute.gain.value = 0.0;
  mute.connect(ctx.destination);
  proc.connect(mute);
};



var ctx = Waml.getAudioContext();





var tri = new Waml.synthesizers['TriOscillator'].create(ctx);
tri.frequency.value = 110;
var osc = ctx.createOscillator();
osc.frequency.value = 0.07;
osc.type="sine";
var shaper = ctx.createWaveShaper();
shaper.curve = new Float32Array([1,200]);
osc.connect(shaper);
osc.start(0);
shaper.connect(tri.frequency);
tri.noteOn();

var trm = new Waml.effectors['SimpleTremolo'].create(ctx);
trm.depth.value = 2.4;
trm.frequency.value = 0.0;
console.log(trm);
trm.connect(ctx.destination);
tri.connect(trm.inlet);
//Waml.DCOffset(1).connect(trm.inlet);

var mod = ctx.createOscillator();
mod.frequency.value = 0.1;
mod.start();
var modrange = ctx.createWaveShaper();
modrange.curve = new Float32Array([0.04,20]);
mod.connect(modrange);
modrange.connect(trm.frequency);
WaveFormRenderer(ctx,trm);





  </script>
  </body>
</html>
